name: Deploy

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  TF_BACKEND_BUCKET: "123456789012-test-deployments"
  AWS_REGION: "us-east-1"
  TF_VAR_service: "test-huge"
  TF_VAR_aws_region: "us-east-1"
  AWS_ACCOUNT_ID: "123456789012"

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: make validate

  deploy:
    name: Deploy ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        environment: [dev, stage, prod]
    env:
      TF_BACKEND_KEY: ${{ matrix.environment }}/test-huge/terraform.tfstate
      TF_VAR_environment: ${{ matrix.environment }}
      TF_VAR_create_vpc: "true"
      TF_VAR_create_nat: "true"
      TF_VAR_create_firewalls: "true"
      TF_VAR_instance_count: "15"
      TF_VAR_app_count: "50"
      TF_VAR_app_per_az_count: "4"
      TF_VAR_nat_count: "3"
      TF_VAR_firewall_count: "5"
      TF_VAR_endpoint_count_per_service: "2"
      TF_VAR_instances_per_app_module: "3"
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      INFRASTRUCTURE_PROVENANCE_TOKEN: ${{ secrets.INFRASTRUCTURE_PROVENANCE_TOKEN }}
      INFRASTRUCTURE_PROVENANCE_PATH: ${{ github.workspace }}/infrastructure-provenance
    steps:
      - uses: actions/checkout@v4
      - name: Checkout infrastructure-provenance (harness)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/infrastructure-provenance
          path: infrastructure-provenance
          token: ${{ secrets.INFRASTRUCTURE_PROVENANCE_TOKEN }}
      - uses: hashicorp/setup-terraform@v3
      - name: Configure git for private module (tfmodules-test)
        run: |
          if [ -n "$INFRASTRUCTURE_PROVENANCE_TOKEN" ]; then
            git config --global url."https://oauth2:${INFRASTRUCTURE_PROVENANCE_TOKEN}@github.com/".insteadOf "https://github.com/"
          fi
      - name: Copy scripts from infrastructure-provenance
        run: |
          mkdir -p scripts
          cp -r infrastructure-provenance/scripts/test-harness/* scripts/
          cp -r infrastructure-provenance/repo_editor scripts/
      - name: Install dependencies for mock script
        run: |
          pip install python-hcl2 boto3 PyGithub PyYAML sqlalchemy psycopg2-binary
      - name: Wire mock apply
        run: |
          echo "REAL_TERRAFORM=$(which terraform)" >> $GITHUB_ENV
          echo "${{ github.workspace }}/scripts" >> $GITHUB_PATH
      - name: Terraform Init
        env:
          PYTHONPATH: ${{ env.INFRASTRUCTURE_PROVENANCE_PATH }}
        run: make init
      - name: Terraform Plan
        env:
          PYTHONPATH: ${{ env.INFRASTRUCTURE_PROVENANCE_PATH }}
        run: make plan
      - name: Terraform Apply (mock)
        env:
          PYTHONPATH: ${{ env.INFRASTRUCTURE_PROVENANCE_PATH }}
        run: make apply
